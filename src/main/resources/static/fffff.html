<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shop - Scrollable List with Filters</title>
  <style>
    @font-face {
        font-family: 'Nunito-Black';
        src: url('fonts/Nunito-Black.ttf') format('truetype');
    }

    body {
        font-family: 'Nunito-Black', Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-image: url('/static/fffon.jpg');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        height: 100vh;
    }

    .navbar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background: rgba(51, 51, 51, 0.8);
        color: white;
        padding: 15px;
        display: flex;
        align-items: center;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
    }

    .navbar .logo a {
        font-size: 20px;
        font-weight: bold;
        color: white;
        text-decoration: none;
        margin-left: 20px;
        transition: 0.3s;
    }

    .navbar .logo a:hover {
        color: #ffcc00;
    }

    .navbar .nav-links {
        display: flex;
        margin-left: 20px;
    }

    .navbar .nav-links a {
        color: white;
        text-decoration: none;
        margin-left: 20px;
        font-size: 16px;
        transition: 0.3s;
    }

    .navbar .nav-links a:hover {
        color: #ffcc00;
    }

    .filter-container {
        position: fixed;
        top: 53px;
        left: 0;
        width: 250px;
        background-color: rgba(51, 51, 51, 0.8);
        padding: 20px;
        color: white;
        height: calc(100vh - 80px);
        overflow-y: auto;
        box-shadow: 2px 0px 5px rgba(0, 0, 0, 0.2);
    }

    .filter-container h3 {
        margin-bottom: 20px;
        font-size: 18px;
    }

    .filter-container select {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #fff;
        color: #333;
    }

    .search-container {
        margin-left: 300px;
        margin-top: 50px;
        width: 1575px;
        padding-bottom: 2px;
        padding-left: 10px;
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .search-container input {
        width: 1000px;
        max-width: 100%;
        padding: 16px;
        margin: 10px 0;
        margin-left: 20px;
        font-size: 18px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #fff;
        color: #333;
    }

    .product-list-container {
        margin-left: 280px;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 20px;
        width: calc(100% - 250px - 20px);
        height: calc(100vh - 120px);
        overflow-y: auto;
    }

    .container {
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
        border-radius: 10px;
        padding: 10px;
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;
        box-sizing: border-box;
    }

    .item {
        background: #e3e3e3;
        margin: 10px;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        font-size: 18px;
        flex: 1 1 200px;
        box-sizing: border-box;
    }

    .loader {
        text-align: center;
        font-size: 16px;
        padding: 10px;
        display: none;
    }
  </style>
</head>
<body>

<div class="navbar">
  <div class="logo"><a href="shop.html">MyApp</a></div>
  <div class="nav-links">
    <a href="#">Profile</a>
    <a href="#" id="logout-button">Logout</a>
  </div>
</div>

<div class="filter-container">
  <h3>Filter Products</h3>
  <select id="exterior-filter"></select>
  <select id="gun-filter"></select>
  <select id="quality-filter"></select>
  <select id="type-filter"></select>
</div>

<div class="search-container">
  <input type="text" id="search" placeholder="Search items..." />
</div>

<div class="product-list-container">
  <div class="container" id="list-container"></div>
  <div class="loader" id="loader">Loading...</div>
</div>

<script type="module" src="/static/frontend/filters.js"></script>
<script type="module" src="/static/frontend/app.js"></script> <!-- ✅ Подключаем app.js -->


<script>
  document.addEventListener("DOMContentLoaded", () => {
      const container = document.getElementById("list-container");
      const loader = document.getElementById("loader");
      const searchInput = document.getElementById("search");

      const filters = {
          exterior: document.getElementById("exterior-filter"),
          gun: document.getElementById("gun-filter"),
          quality: document.getElementById("quality-filter"),
          type: document.getElementById("type-filter")
      };

      let allItems = [];
      let loading = false;
      const STORAGE_EXPIRATION = 60 * 60 * 1000;

      const filterOptions = {
          exterior: ["All", "Factory New", "Minimal Wear", "Field-Tested", "Well-Worn", "Battle-Scarred"],
          gun: ["All", "Galil AR", "AK-47", "AUG", "FAMAS", "M4A1-S", "M4A4", "SG 553", "CZ75-Auto", "Desert Eagle",
              "Dual Berettas", "Five-SeveN", "Glock-18", "P2000", "P250", "R8 Revolver", "Tec-9", "USP-S", "Bayonet"],
          quality: ["All", "Consumer Grade", "Industrial Grade", "Mil-Spec Grade", "Restricted", "Classified",
              "Covert", "Extraordinary", "Remarkable", "High Grade", "Base Grade", "Exotic", "Superior"],
          type: ["All", "Agent", "Charm", "Rifle", "Graffiti", "Shotgun", "Tool", "Container", "Music Kit",
              "Sticker", "Patch", "Knife", "Gloves", "Pistol", "SMG", "Gift", "Pass", "Machinegun", "Sniper Rifle"]
      };

      function populateSelect(filterId, options) {
          const select = filters[filterId];
          if (select) {
              select.innerHTML = options.map(option => `<option value="${option}">${option}</option>`).join("");
          }
      }

      function extractProperty(title, values) {
          return values.find(value => title.includes(value)) || null;
      }

      function applyFilters() {
          const searchQuery = searchInput.value.toLowerCase();
          const selectedExterior = filters.exterior.value;
          const selectedGun = filters.gun.value;
          const selectedQuality = filters.quality.value;
          const selectedType = filters.type.value;

          const filteredItems = allItems.filter(item => {
              return (
                  (selectedExterior === "All" || extractProperty(item.title, filterOptions.exterior) === selectedExterior) &&
                  (selectedGun === "All" || extractProperty(item.title, filterOptions.gun) === selectedGun) &&
                  (selectedQuality === "All" || item.title.includes(selectedQuality)) &&
                  (selectedType === "All" || item.title.includes(selectedType)) &&
                  (searchQuery === "" || item.title.toLowerCase().includes(searchQuery))
              );
          });

          displayItems(filteredItems);
      }

      function displayItems(items) {
          container.innerHTML = "";
          items.forEach(item => {
              const itemElement = document.createElement("div");
              itemElement.classList.add("item");

              itemElement.innerHTML = `
                  <img src="${item.image}" alt="${item.title}" style="max-width: 100px; max-height: 100px;">
                  <div>${item.title}</div>
                  <div>Type: ${item.asset_description?.type || "No Type"}</div>
                  <div>Price: ${item.price}</div>
              `;
              container.appendChild(itemElement);
          });
      }

      async function fetchItems() {
          try {
              const storedSkins = localStorage.getItem("skins");
              const lastUpdated = localStorage.getItem("skinsLastUpdated");

              if (storedSkins && lastUpdated && (Date.now() - lastUpdated < STORAGE_EXPIRATION)) {
                  allItems = JSON.parse(storedSkins);
                  applyFilters();
                  return;
              }

              const response = await fetch("http://localhost:3000/api/market");
              if (!response.ok) {
                  throw new Error(`HTTP error! Status: ${response.status}`);
              }

              const data = await response.json();
              if (data && Array.isArray(data.results)) {
                  allItems = data.results.map(item => ({
                      image: `https://community.cloudflare.steamstatic.com/economy/image/${item.asset_description.icon_url}`,
                      title: item.name || "Unknown Item",
                      asset_description: item.asset_description || { type: "No Type" },
                      price: item.sell_price_text || "N/A"
                  }));

                  localStorage.setItem("skins", JSON.stringify(allItems));
                  localStorage.setItem("skinsLastUpdated", Date.now().toString());
                  applyFilters();
              }
          } catch (error) {
              console.error("Ошибка при загрузке скинов:", error);
          } finally {
              loading = false;
              loader.style.display = "none";
          }
      }

      Object.values(filters).forEach(filter => filter.addEventListener("change", applyFilters));
      searchInput.addEventListener("input", applyFilters);

      Object.keys(filterOptions).forEach(key => populateSelect(key, filterOptions[key]));

      fetchItems();
  });
</script>

</body>
</html>
